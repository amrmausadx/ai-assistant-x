{% extends 'base.html' %}
{% block title %}Generation - Creative Writing Assistant{% endblock %}

{% block content %}
<h1>‚úçÔ∏è Creative Generation</h1>

<form id="generationForm">
  <div class="form-group">
    <label for="styleprompt">Generation Style:</label>
    <select id="styleprompt" name="styleprompt">
      <option value="story" selected>story</option>
      <option value="creative">creative</option>
      <option value="poem">poem</option>
    </select>
  </div>
  <div class="form-group">
      <label for="prompt">Your text / prompt</label>
      <textarea id="prompt" name="prompt" rows="6" style="width:100%;padding:10px;font-size:15px;">The last dragon egg hatched deep within the mountain cavern.</textarea>
  </div>
  <div class="form-group">
            <label for="model_name">Base Model:</label>
            <select id="model_name" name="model_name">
                <option value="gpt2">GPT-2 (117M)</option>
                <option value="gpt2-medium">GPT-2 Medium (345M)</option>
                <option value="gpt2-large">GPT-2 Large (774M)</option>
                <option value="distilgpt2">DistilGPT-2 (82M)</option>
                <option value="Qwen/Qwen2.5-1.5B-Instruct">Qwen 2.5B</option>
                <option value="./gpt2_finetuned/">Your Finetuned Model</option>
            </select>
   </div>
  <div class="form-row">
    <div class="form-group">
      <label for="max_length">Max length</label>
      <input id="max_length" name="max_length" type="number" value="200" />
    </div>
    <div class="form-group">
      <label for="temperature">Temperature</label>
      <input id="temperature" name="temperature" type="number" step="0.1" value="0.9" />
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="experiment_name">Experiment Name</label>
      <input id="experiment_name" name="experiment_name" type="text" value="creative-writing" />
    </div>
  </div>

  <button type="submit" id="generateBtn" class="btn">‚ú® Start Generation</button>
</form>

<div id="generationProgressContainer" class="progress-container" style="display:none;">
  <h3>Generation Progress</h3>
  <div class="progress-bar">
    <div id="generationProgressFill" class="progress-fill"></div>
  </div>
  <div id="generationProgressText">0%</div>
  <div id="generationStatusMessage" class="status-message status-info">Initializing...</div>
</div>

<div id="generationMlflowInfo" style="background:#e6fffa;padding:15px;border-radius:8px;margin-top:20px;border:1px solid #81e6d9;display:none;">
  <h3>üî¨ MLflow Generation Tracking</h3>
  <p><strong>Experiment:</strong> <span id="generationExperiment">-</span></p>
  <p><strong>Run ID:</strong> <span id="generationRunId">-</span></p>
  <p><strong>Start Time:</strong> <span id="generationStartTime">-</span></p>
  <p><strong>End Time:</strong> <span id="generationEndTime">-</span></p>
  <p><strong>Perplexity:</strong> <span id="generationPerplexity">-</span></p>
  <p><strong>BLEU Score:</strong> <span id="generationBleuScore">-</span></p>
  <p><strong>ROUGE-1 F1 Score:</strong> <span id="generationRouge1Fmeasure">-</span></p>
</div>

<div class="card" style="margin-top:20px;">
  <h3>Output</h3>
  <pre id="output" style="white-space:pre-wrap;min-height:200px;padding:10px;background:#fff;border-radius:6px;border:1px solid #eee;"></pre>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let generationStatusInterval;

document.getElementById('generationForm').addEventListener('submit', function(e) {
  e.preventDefault();
  startGeneration();
});

function startGeneration() {
  const btn = document.getElementById('generateBtn');
  const progressContainer = document.getElementById('generationProgressContainer');
  const mlflowInfo = document.getElementById('generationMlflowInfo');

  btn.disabled = true;
  btn.textContent = '‚è≥ Generating...';
  progressContainer.style.display = 'block';
  mlflowInfo.style.display = 'block';

  // Guardrail and check for the style element
  const styleElement = document.getElementById('styleprompt');
  
  
  if (!styleElement) {
      console.error("ERROR: Could not find element with ID 'styleprompt'. UI structure might be incorrect.");
      document.getElementById('generationStatusMessage').textContent = "ERROR: Missing UI element.";
      btn.disabled = false;
      return;
  }

  const config = {
    style: styleElement.value,
    prompt: document.getElementById('prompt').value,
    model_name: document.getElementById('model_name').value,
    max_length: parseInt(document.getElementById('max_length').value),
    temperature: parseFloat(document.getElementById('temperature').value),
    experiment_name: document.getElementById('experiment_name').value
  };

  fetch('/api/generating/start', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(config)
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'started') {
      generationStatusInterval = setInterval(checkGenerationStatus, 2000);
    } else {
      alert('Failed to start: ' + data.message);
      resetGenerationUI();
    }
  })
  .catch(err => {
    alert('Error: ' + err.message);
    resetGenerationUI();
  });
}

function checkGenerationStatus() {
  fetch('/api/generating/status')
    .then(response => response.json())
    .then(data => {
      const progressFill = document.getElementById('generationProgressFill');
      const progressText = document.getElementById('generationProgressText');
      const statusMessage = document.getElementById('generationStatusMessage');
      const runId = document.getElementById('generationRunId');
      const startTime = document.getElementById('generationStartTime');
      const endTime = document.getElementById('generationEndTime');
      const experiment_name = document.getElementById('generationExperiment');
      const current_perplexity = document.getElementById('generationPerplexity');

      // Update progress
      progressFill.style.width = data.progress + '%';
      progressText.textContent = data.progress + '%';
                
      // Update status message
      statusMessage.textContent = data.message;
      statusMessage.className = 'status-message ' + 
            (data.error ? 'status-error' : 
             data.progress === 100 ? 'status-success' : 'status-info');

      if (data.run_id) document.getElementById('generationRunId').textContent = data.run_id;
      if (data.start_time) document.getElementById('generationStartTime').textContent = data.start_time;
      if (data.end_time) document.getElementById('generationEndTime').textContent = data.end_time;
      document.getElementById('generationExperiment').textContent = data.experiment_name || '-';
      if (data.current_perplexity) document.getElementById('generationPerplexity').textContent = data.current_perplexity.toFixed(2);
      if (data.bleu_score) document.getElementById('generationBleuScore').textContent = data.bleu_score.toFixed(4);
      if (data.rouge1_fmeasure) document.getElementById('generationRouge1Fmeasure').textContent = data.rouge1_fmeasure.toFixed(4);

      if (data.output_text) document.getElementById('output').textContent = data.output_text;
      
           
       // Check if training is complete
       if (!data.running) {
          clearInterval(generationStatusInterval);
          resetGenerationUI();
        }
    });
}

function resetGenerationUI() {
  const btn = document.getElementById('generateBtn');
  btn.disabled = false;
  btn.textContent = '‚ú® Start Generation';
  //console.log('UI reset - button enabled'); // Debug log
}
</script>
{% endblock %}
